<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Dealing with long-lived child processes in Rust: Part 2</title>
    <meta name="description" content="How to handle signals so that child processes get cleaned up.">
    <link rel="stylesheet" href="/css/typography.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.21.0/themes/prism-okaidia.css">
  </head>
  <body>
    <header class="blog-header">
      <h3 class="home"><a class="title" href="/">nikbrendler.com</a></h3>
      <nav class="pages">
        <a href="/projects/">projects</a>
      </nav>
      <nav class="social">
        <a href="https://github.com/nbrendler">
          <img src="/img/github.png" />
        </a>
        <a href="https://twitter.com/NikBrendler">
          <img src="/img/twitter.png" />
        </a>
      </nav>
    </header>
    <main>
    <h1>Dealing with long-lived child processes in Rust: Part 2</h1>

<p>In <a href="/rust-process-communication">part one</a> I went over a few of the methods I
tried for communicating between different processes in Rust. These all worked
great with one caveat -- the child process doesn't always get cleaned up.</p>
<p>I originally thought I wouldn't have to deal with this, because I didn't see
them in the process list; however, I didn't know that <a href="https://github.com/rust-lang/cargo/issues/5598">Cargo automatically
cleans up child processes</a>, but
it turns out that this isn't always the case. I believe if your main program
exits successfully, the child processes are not cleaned up, which probably makes
sense for some use cases. In my case, I needed them to be closed , so I figured
it's better to be explicit and figure out how to clean them up rather than rely
on a feature of Cargo.</p>
<p>To remedy this I introduced the <code>signal-hook</code> crate with its very simple
interface.</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BufRead</span><span class="token punctuation">,</span> <span class="token class-name">BufReader</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token punctuation">,</span> <span class="token class-name">Write</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Child</span><span class="token punctuation">,</span> <span class="token class-name">ChildStdin</span><span class="token punctuation">,</span> <span class="token class-name">ChildStdout</span><span class="token punctuation">,</span> <span class="token class-name">Command</span><span class="token punctuation">,</span> <span class="token class-name">Stdio</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>channel<span class="token punctuation">,</span> <span class="token class-name">Receiver</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">,</span> <span class="token class-name">TryRecvError</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">atomic<span class="token punctuation">::</span></span><span class="token class-name">AtomicBool</span><span class="token punctuation">,</span> <span class="token namespace">atomic<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span>sleep<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token namespace">signal_hook<span class="token punctuation">::</span></span><span class="token constant">SIGTERM</span><span class="token punctuation">;</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_process_thread</span><span class="token punctuation">(</span>child<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Child</span><span class="token punctuation">,</span> sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> stdin <span class="token operator">=</span> child<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> stdout <span class="token operator">=</span> child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>            <span class="token keyword">match</span> receiver<span class="token punctuation">.</span><span class="token function">try_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Ok</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    stdin<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">TryRecvError</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token keyword">continue</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">match</span> f<span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token keyword">continue</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"an error!: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token keyword">break</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_process</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Child</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> child <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"cat"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">stdin</span><span class="token punctuation">(</span><span class="token class-name">Stdio</span><span class="token punctuation">::</span><span class="token function">piped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">stdout</span><span class="token punctuation">(</span><span class="token class-name">Stdio</span><span class="token punctuation">::</span><span class="token function">piped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to start process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token function">start_process_thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> child<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Started process: {}"</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    child<br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_command_thread</span><span class="token punctuation">(</span>mutex<span class="token punctuation">:</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> sender <span class="token operator">=</span> mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        sender<br>            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Command from the thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx1<span class="token punctuation">,</span> rx1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx2<span class="token punctuation">,</span> rx2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">let</span> <span class="token keyword">mut</span> child <span class="token operator">=</span> <span class="token function">start_process</span><span class="token punctuation">(</span>tx1<span class="token punctuation">,</span> rx2<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    tx2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Command 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">start_command_thread</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx2<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">let</span> should_terminate <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token namespace">signal_hook<span class="token punctuation">::</span>flag<span class="token punctuation">::</span></span><span class="token function">register</span><span class="token punctuation">(</span><span class="token constant">SIGTERM</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>should_terminate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">while</span> <span class="token operator">!</span>should_terminate<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">match</span> rx1<span class="token punctuation">.</span><span class="token function">try_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Ok</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Got this back: {}"</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">TryRecvError</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">continue</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    child<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><br>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>This has undergone a few minor changes.</p>
<ol>
<li>The <code>start_process</code> method now results the child it creates, so that we can
kill it later. You could also store this handle in another data structure,
too.</li>
<li>The thread-launching function was split in two. One of them starts the
process and gives a mutable reference to the second function. The second
function grabs the stdin and stdout streams from the process and gives those
to the thread, without taking ownership of the whole child process object.</li>
<li>We changed the main loop to check a bool whether or not it should continue.
The <code>signal-hook</code> crate gives the ability to flip this bool when a SIGTERM is
received, such as Ctrl-C from the terminal.</li>
<li>Now we can kill the child at the end of the main function, since the loop
finishing means we're all done.</li>
</ol>
<p>This isn't totally foolproof. The operating system could kill the program to
reclaim resources by sending a SIGKILL (which processes cannot prevent), so our
cleanup line won't run. But under normal operations the child will be closed.</p>
<p>The tricky part for me when writing this was (2). How can I keep a reference to
the child around (for killing it later), while still giving the thread ownership
over the io streams it needs to work? In this case, I think what I've done is
the simplest, just surgically removing the streams from the child and giving
them to the thread. If that won't work for what you're doing (maybe multiple
children need to read or write to the streams), you can probably just wrap the
child object in a thread-safe container like <code>Arc&lt;Mutex&gt;</code>.</p>
<p>I tend to reach for things like <code>Arc&lt;Mutex&gt;</code> (or dynamic dispatch with <code>Box&lt;dyn trait&gt;</code>, for other problems) as a last resort while still learning the ins and
outs of Rust, because to me the best way to improve is to better understand the
borrow checker and what it's telling you, and things like <code>Arc&lt;Mutex&gt;</code> feel like
breaking the rules. However, there are times when they are the right tool for
the job and this is probably one of them.</p>


<hr>
<ul class="nextprev"><li><-- <a href="/on-productivity/">On productivity</a></li><li><a href="/rust-process-communication/">Dealing with long-lived child processes in Rust: Part 1</a> --></li>
</ul>

    </main>
  </body>
</html>
