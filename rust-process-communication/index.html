<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Dealing with long-lived child processes in Rust: Part 1</title>
    <meta name="description" content="Notes on dealing with child processes that I found a bit tricky or not documented well.">
    <link rel="stylesheet" href="/css/typography.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.21.0/themes/prism-okaidia.css">
  </head>
  <body>
    <header class="blog-header">
      <h3 class="home"><a class="title" href="/">nikbrendler.com</a></h3>
      <nav class="pages">
        <a href="/projects/">projects</a>
      </nav>
      <nav class="social">
        <a href="https://github.com/nbrendler">
          <img src="/img/github.png" />
        </a>
        <a href="https://twitter.com/NikBrendler">
          <img src="/img/twitter.png" />
        </a>
      </nav>
    </header>
    <main>
    <h1>Dealing with long-lived child processes in Rust: Part 1</h1>

<p>I've been writing a small program in Rust to fill a need I have with my current
setup (a terminal-based chat client for Keybase). It's my first foray into some
areas of Rust like async and spawning child processes, and also my first
terminal UI.</p>
<p>One requirement of the program was to run a background process (the chat
listener) that would communicate back to the main process when it received an
event (a new chat message). Most child processes in my experience are usually a
one-and-done affair. Run it, collect the output and be on your merry way. Here I
had a need to keep it running in the background, send the output asynchronously
to my UI thread, and make sure to clean up the process when my program exits.</p>
<p>This all ended up being a bit tricky for an unexperienced Rust programmer like
me, so I'm documenting a few of the challenges and approaches I tried to solve
it, along with what I ended up with.</p>
<p>For this Part 1, I'll talk about different ways to communicate with the
processes. Part 2 will cover signal handling to clean up the processes when the
main process is interrupted.</p>
<h3>Async communication with processes</h3>
<p>Problem: After spawning a child process, how should it communicate back to the
main process?</p>
<p>The Rust documentation for the
<a href="https://doc.rust-lang.org/std/process/index.html">process</a> module is all
blocking and waiting for child output, but a quick search gives you a few
options: callbacks, channels, or tokio (streams and async/await).</p>
<p>For a simple cases, callbacks should be the first thing you reach for.  Here's
an example where I grab a line from stdout and send it back with my callback.</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BufRead</span><span class="token punctuation">,</span> <span class="token class-name">BufReader</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Command</span><span class="token punctuation">,</span> <span class="token class-name">Stdio</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span>sleep<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_listener</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>cb<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> child <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"ping"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"google.com"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">stdout</span><span class="token punctuation">(</span><span class="token class-name">Stdio</span><span class="token punctuation">::</span><span class="token function">piped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to start ping process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Started process: {}"</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">match</span> f<span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token function">cb</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"an error!: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">start_listener</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Got this back: {}"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>This is a bit contrived, but there's still a few things to unwrap.</p>
<ul>
<li>We sleep for five seconds to let <code>ping</code> give us something to look at, but in
a real program we could be doing other things -- in my case, running the
rendering loop for the terminal UI.</li>
<li>We're not doing anything interesting in the callback. Just printing is a bit
of a cop-out, because you won't run afoul of any ownership constraints
imposed by Rust. Note how the callback is required to have a static
lifetime (because the thread could have a static lifetime), so the
compiler will likely yell at us if we tried to do anything interesting.</li>
<li>We're not doing any cleanup of the <code>Child</code> process, so the <code>ping</code> command
will continue to run forever until killed. I believe this is handled by
Cargo in simple cases like this, but we need to handle it ourselves as
Cargo won't always be running the binary for us.</li>
</ul>
<p>Here's the same thing, but now we're using a channel instead of a callback.</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BufRead</span><span class="token punctuation">,</span> <span class="token class-name">BufReader</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Command</span><span class="token punctuation">,</span> <span class="token class-name">Stdio</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>channel<span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">,</span> <span class="token class-name">TryRecvError</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span>sleep<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_listener</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> child <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"ping"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"google.com"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">stdout</span><span class="token punctuation">(</span><span class="token class-name">Stdio</span><span class="token punctuation">::</span><span class="token function">piped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to start ping process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Started process: {}"</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>            <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">match</span> f<span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"an error!: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">start_listener</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>        <span class="token keyword">match</span> rx<span class="token punctuation">.</span><span class="token function">try_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Ok</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Got this back: {}"</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">TryRecvError</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">continue</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Note that this will run forever until you hit Ctrl-C, so our 'Done!' will never
be reached. It is possible to use a timeout to get the same behavior as above,
but I haven't implemented it here.</p>
<p>This is what I ended up settling on for my program, as it gives a little bit
more flexibility. The channel parts can be very cheaply cloned and stored in
other structs if desired. The <a href="https://crates.io/crates/crossbeam">crossbeam</a>
crate, which is a mostly drop-in replacement for the message-based tools
included in the standard library, has a <code>select!</code> macro that nicely encapsulates
the loop logic, and is purportedly much faster.</p>
<h3>Bidirectional communication</h3>
<p>Problem: What if I want to be able to send more information to the process via
stdin, while still getting information back from it?</p>
<p>While you could accomplish this using callbacks, this is more of a textbook case
for using channels. Below I've modified our example to work as more of an echo
server. We send it input that will be echoed back after a delay. Note that we
now need two channels, one to send information to the child, and one for the
child to send back to us.</p>
<pre class="language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BufRead</span><span class="token punctuation">,</span> <span class="token class-name">BufReader</span><span class="token punctuation">,</span> <span class="token class-name">Write</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>process<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Command</span><span class="token punctuation">,</span> <span class="token class-name">Stdio</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>mpsc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>channel<span class="token punctuation">,</span> <span class="token class-name">Receiver</span><span class="token punctuation">,</span> <span class="token class-name">Sender</span><span class="token punctuation">,</span> <span class="token class-name">TryRecvError</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span>sleep<span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_process</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> child <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"cat"</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">stdin</span><span class="token punctuation">(</span><span class="token class-name">Stdio</span><span class="token punctuation">::</span><span class="token function">piped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">stdout</span><span class="token punctuation">(</span><span class="token class-name">Stdio</span><span class="token punctuation">::</span><span class="token function">piped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to start process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Started process: {}"</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">let</span> <span class="token keyword">mut</span> stdin <span class="token operator">=</span> child<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>            <span class="token keyword">match</span> receiver<span class="token punctuation">.</span><span class="token function">try_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Ok</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    stdin<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">TryRecvError</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token keyword">continue</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">let</span> <span class="token keyword">mut</span> buf <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">match</span> f<span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token keyword">continue</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"an error!: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                    <span class="token keyword">break</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">start_command_thread</span><span class="token punctuation">(</span>mutex<span class="token punctuation">:</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> sender <span class="token operator">=</span> mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        sender<br>            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Command from the thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx1<span class="token punctuation">,</span> rx1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx2<span class="token punctuation">,</span> rx2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token function">start_process</span><span class="token punctuation">(</span>tx1<span class="token punctuation">,</span> rx2<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    tx2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Command 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">start_command_thread</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">loop</span> <span class="token punctuation">{</span><br>        <span class="token keyword">match</span> rx1<span class="token punctuation">.</span><span class="token function">try_recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Ok</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Got this back: {}"</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">TryRecvError</span><span class="token punctuation">::</span><span class="token class-name">Empty</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">continue</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Error: {:?}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Note that we have to use a mutex because <code>Send</code> is not implemented for the
sender objects. This is also done by crossbeam, but I wanted to avoid extra
crates for the example. I'm also cloning the sender somewhat unnecessarily to
avoid it being dropped (and closing the channel) when the command thread
finishes.</p>
<p>This is mostly there now, minus one problem. If you grep for <code>cat</code> processes,
you probably have a few zombified processes lingering around. In part 2 we'll
discuss signal handling and the cleanup.</p>


<hr>
<ul class="nextprev"><li><-- <a href="/rust-process-communication-part-2/">Dealing with long-lived child processes in Rust: Part 2</a></li><li><a href="/kernel-status-script/">Kernel status script</a> --></li>
</ul>

    </main>
  </body>
</html>
