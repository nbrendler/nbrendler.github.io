<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Kernel status script</title>
    <meta name="description" content="A script to check if I need to reboot for kernel changes.">
    <link rel="stylesheet" href="/css/typography.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/prismjs@1.21.0/themes/prism-okaidia.css">
  </head>
  <body>
    <header class="blog-header">
      <h3 class="home"><a class="title" href="/">nikbrendler.com</a></h3>
      <nav class="pages">
        <a href="/projects/">projects</a>
      </nav>
      <nav class="social">
        <a href="https://github.com/nbrendler">
          <img src="/img/github.png" />
        </a>
        <a href="https://twitter.com/NikBrendler">
          <img src="/img/twitter.png" />
        </a>
      </nav>
    </header>
    <main>
    <h1>Kernel status script</h1>

<p>When developing on Arch Linux, kernel updates happen pretty frequently. For most
things, this is fine and I can continue working. For some things, notably
Docker, I need to reboot my machine after the kernel is updated. This probably
depends on what storage driver you use and such, but currently I use overlayfs
which is loaded by the kernel. You might be able to get away with just modprobe
but I tend to just restart as it's quick and easy.</p>
<p>To remind myself when this happens, I wrote this script:</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><br><br><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span>pacman --query linux<span class="token variable">`</span></span> <span class="token operator">=</span>~ ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">)</span><span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">installed_kernel</span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">BASH_REMATCH</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><br><br><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> --kernel-release<span class="token variable">`</span></span> <span class="token operator">=</span>~ ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">)</span><span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">running_kernel</span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">BASH_REMATCH</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$running_kernel</span>"</span> <span class="token operator">!=</span> <span class="token string">"<span class="token variable">$installed_kernel</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">then</span><br>  <span class="token builtin class-name">echo</span> <span class="token string">"Restart (<span class="token variable">$installed_kernel</span>)"</span><br><span class="token keyword">else</span><br>  <span class="token builtin class-name">printf</span> <span class="token string">"OK (<span class="token variable">$running_kernel</span>)"</span><br><span class="token keyword">fi</span></code></pre>
<p>This will print out <code>OK (5.3.1)</code> if my installed kernel matches the running one,
or <code>Restart (5.3.1)</code> if my running kernel is older. Then I added the script to
my path and call it in xmobar config like so:</p>
<pre><code>Run Com &quot;kernelstatus&quot; [] &quot;kernel&quot; 1000
</code></pre>
<p>And now I can see it in my status bar:</p>
<p><img src="/img/xmobar.png" alt="The kernel status"></p>
<p>I haven't figured out an <em>easy</em> way to color the output of a custom command like
this in xmobar (without dusting off my Haskell skills), but will update if I do.</p>
<p>Update (2019-11-12): Arch changed the version string returned by <code>pacman --query linux</code> to no longer contain the word <code>arch</code>, so here's an updated script:</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><br><br><span class="token comment"># e.g. linux 5.3.10.1-1</span><br><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span>pacman --query linux<span class="token variable">`</span></span> <span class="token operator">=</span>~ ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+-<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">)</span><span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">installed_kernel</span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">BASH_REMATCH</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><br><br><span class="token comment"># e.g. 5.3.10-arch1-1</span><br><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> --kernel-release<span class="token variable">`</span></span> <span class="token operator">=</span>~ ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">\</span>.<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>+<span class="token punctuation">[</span><span class="token number">0</span>-9<span class="token punctuation">]</span>?<span class="token punctuation">)</span><span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">running_kernel</span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">BASH_REMATCH</span><span class="token punctuation">[</span>2<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$running_kernel</span>"</span> <span class="token operator">!=</span> <span class="token string">"<span class="token variable">$installed_kernel</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token keyword">then</span><br>  <span class="token builtin class-name">echo</span> <span class="token string">"Restart (<span class="token variable">$installed_kernel</span>)"</span><br><span class="token keyword">else</span><br>  <span class="token builtin class-name">printf</span> <span class="token string">"OK (<span class="token variable">$running_kernel</span>)"</span><br><span class="token keyword">fi</span><br></code></pre>


<hr>
<ul class="nextprev"><li><-- <a href="/rust-process-communication/">Dealing with long-lived child processes in Rust: Part 1</a></li><li><a href="/making-gifs/">Making quick &amp; easy gifs for pull requests (Linux)</a> --></li>
</ul>

    </main>
  </body>
</html>
